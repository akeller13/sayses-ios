cmake_minimum_required(VERSION 3.20)
project(SaysesCore VERSION 1.0.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# iOS specific settings
if(CMAKE_SYSTEM_NAME STREQUAL "iOS")
    set(CMAKE_OSX_DEPLOYMENT_TARGET "15.0")
    set(CMAKE_XCODE_ATTRIBUTE_ONLY_ACTIVE_ARCH NO)
endif()

# Find required packages
find_package(OpenSSL REQUIRED)

# Opus codec (bundled or system)
option(USE_SYSTEM_OPUS "Use system Opus library" OFF)
if(USE_SYSTEM_OPUS)
    find_package(PkgConfig REQUIRED)
    pkg_check_modules(OPUS REQUIRED opus)
else()
    # Build Opus from source
    add_subdirectory(third_party/opus EXCLUDE_FROM_ALL)
endif()

# Speex DSP for preprocessing
option(USE_SYSTEM_SPEEX "Use system Speex library" OFF)
if(USE_SYSTEM_SPEEX)
    find_package(PkgConfig REQUIRED)
    pkg_check_modules(SPEEX REQUIRED speexdsp)
endif()

# Protobuf for Mumble protocol
find_package(Protobuf REQUIRED)

# Protobuf generated files (pre-generated by build script)
# Run: ./Scripts/build_core.sh proto
set(PROTO_GENERATED_DIR ${CMAKE_CURRENT_SOURCE_DIR}/src/generated)

# Option to generate protobuf files during cmake (requires protoc)
option(GENERATE_PROTO "Generate protobuf files during build" OFF)
if(GENERATE_PROTO AND Protobuf_FOUND)
    set(PROTO_FILES proto/Mumble.proto)
    protobuf_generate_cpp(PROTO_SRCS PROTO_HDRS ${PROTO_FILES})
else()
    # Use pre-generated files
    set(PROTO_SRCS ${PROTO_GENERATED_DIR}/Mumble.pb.cc)
    set(PROTO_HDRS ${PROTO_GENERATED_DIR}/Mumble.pb.h)
endif()

# Core library sources
set(CORE_SOURCES
    src/audio/audio_engine.cpp
    src/audio/vad.cpp
    src/audio/jitter_buffer.cpp
    src/audio/speex_dsp.cpp
    src/audio/user_audio_buffer.cpp
    src/codec/opus_codec.cpp
    src/codec/speex_codec.cpp
    src/mumble/mumble_client.cpp
    src/mumble/crypto.cpp
    src/mumble/udp_ping.cpp
    ${PROTO_SRCS}
)

set(CORE_HEADERS
    include/audio_engine.h
    include/mumble_client.h
    include/codec.h
    include/vad.h
    include/jitter_buffer.h
    include/speex_dsp.h
    include/user_audio_buffer.h
    ${PROTO_HDRS}
)

# Create static library
add_library(SaysesCore STATIC ${CORE_SOURCES} ${CORE_HEADERS})

target_include_directories(SaysesCore PUBLIC
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${CMAKE_CURRENT_BINARY_DIR}  # For generated protobuf headers
    ${PROTO_GENERATED_DIR}       # For pre-generated protobuf headers
)

target_link_libraries(SaysesCore
    OpenSSL::SSL
    OpenSSL::Crypto
    protobuf::libprotobuf
)

if(USE_SYSTEM_OPUS)
    target_include_directories(SaysesCore PRIVATE ${OPUS_INCLUDE_DIRS})
    target_link_libraries(SaysesCore ${OPUS_LIBRARIES})
else()
    target_link_libraries(SaysesCore opus)
endif()

if(USE_SYSTEM_SPEEX)
    target_include_directories(SaysesCore PRIVATE ${SPEEX_INCLUDE_DIRS})
    target_link_libraries(SaysesCore ${SPEEX_LIBRARIES})
endif()

# iOS Framework target
if(CMAKE_SYSTEM_NAME STREQUAL "iOS")
    set_target_properties(SaysesCore PROPERTIES
        FRAMEWORK TRUE
        FRAMEWORK_VERSION A
        MACOSX_FRAMEWORK_IDENTIFIER com.sayses.core
        VERSION ${PROJECT_VERSION}
        SOVERSION ${PROJECT_VERSION_MAJOR}
        PUBLIC_HEADER "${CORE_HEADERS}"
        XCODE_ATTRIBUTE_CODE_SIGN_IDENTITY "iPhone Developer"
    )
endif()

# Install rules
install(TARGETS SaysesCore
    ARCHIVE DESTINATION lib
    LIBRARY DESTINATION lib
    FRAMEWORK DESTINATION Frameworks
    PUBLIC_HEADER DESTINATION include/SaysesCore
)
